// Generated by Copilot
// ğŸ”µ INFO: Settings page JavaScript - Global and sensor configuration
// âšª NOTE: Handles WiFi, scheduling, and sensor sensitivity settings

let config = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Initialize Page
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('DOMContentLoaded', function () {
  loadConfig();
  setupSliderListeners();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Load Configuration from ESP8266
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadConfig() {
  try {
    const response = await fetch('/api/config');
    config = await response.json();
    updateUIFromConfig();
    updateConnectionStatus(true);
  } catch (error) {
    console.error('Failed to load config:', error);
    updateConnectionStatus(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Update UI from Configuration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateUIFromConfig() {
  // ğŸ”µ INFO: Global settings
  setSliderValue('globalBrightness', config.globalBrightness);
  document.getElementById('debugMode').checked = config.debugMode;

  // ğŸ”µ INFO: Sensor settings
  setSliderValue('accelThreshold', config.sensor.accelThreshold.toFixed(1));
  setSliderValue('debounceDelay', config.sensor.debounceDelay);
  setSliderValue('effectTimeout', config.sensor.effectTimeout / 1000); // Convert to seconds

  // ğŸ”µ INFO: WiFi settings
  document.getElementById('useHomeWiFi').checked = config.wifi.useHomeWiFi;
  document.getElementById('wifiSSID').value = config.wifi.ssid;
  // âšª NOTE: Don't populate password for security

  // ğŸ”µ INFO: Scheduling settings
  document.getElementById('scheduleEnabled').checked = config.schedule.enabled;
  setSliderValue('disableStart', config.schedule.disableStart);
  setSliderValue('disableEnd', config.schedule.disableEnd);
  setSliderValue('timezoneOffset', config.schedule.timezoneOffset / 3600); // Convert to hours

  // ğŸ”µ INFO: Update time displays
  updateTimeDisplay();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Helper Function - Set Slider Value
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setSliderValue(id, value) {
  const slider = document.getElementById(id);
  const display = document.getElementById(id + 'Val');
  if (slider && display) {
    slider.value = value;
    updateSliderDisplay(slider);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Setup Slider Listeners
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setupSliderListeners() {
  const sliders = document.querySelectorAll('input[type="range"]');
  sliders.forEach((slider) => {
    slider.addEventListener('input', function () {
      updateSliderDisplay(this);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Update Slider Display Value
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateSliderDisplay(slider) {
  const display = document.getElementById(slider.id + 'Val');
  if (!display) return;

  const value = parseFloat(slider.value);

  // ğŸ”µ INFO: Format based on slider type
  if (slider.id.includes('Threshold')) {
    display.textContent = value.toFixed(1);
  } else if (slider.id.includes('Start') || slider.id.includes('End')) {
    display.textContent = value.toString().padStart(2, '0') + ':00';
  } else if (slider.id.includes('Offset')) {
    display.textContent = (value >= 0 ? '+' : '') + value;
  } else if (slider.id.includes('Timeout')) {
    display.textContent = value;
  } else {
    display.textContent = value;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Update Time Display
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateTimeDisplay() {
  const startSlider = document.getElementById('disableStart');
  const endSlider = document.getElementById('disableEnd');
  if (startSlider) updateSliderDisplay(startSlider);
  if (endSlider) updateSliderDisplay(endSlider);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Save Settings to ESP8266
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function saveSettings() {
  const saveBtn = document.getElementById('saveBtn');
  const saveStatus = document.getElementById('saveStatus');

  saveBtn.disabled = true;
  saveBtn.textContent = 'ğŸ’¾ Saving...';

  try {
    // ğŸ”µ INFO: Collect all settings
    const configData = {
      globalBrightness: parseInt(document.getElementById('globalBrightness').value),
      debugMode: document.getElementById('debugMode').checked,

      sensor: {
        accelThreshold: parseFloat(document.getElementById('accelThreshold').value),
        debounceDelay: parseInt(document.getElementById('debounceDelay').value),
        effectTimeout: parseInt(document.getElementById('effectTimeout').value) * 1000, // Convert to ms
      },

      wifi: {
        useHomeWiFi: document.getElementById('useHomeWiFi').checked,
        ssid: document.getElementById('wifiSSID').value,
        password: document.getElementById('wifiPassword').value,
      },

      schedule: {
        enabled: document.getElementById('scheduleEnabled').checked,
        disableStart: parseInt(document.getElementById('disableStart').value),
        disableEnd: parseInt(document.getElementById('disableEnd').value),
        timezoneOffset: parseInt(document.getElementById('timezoneOffset').value) * 3600, // Convert to seconds
      },
    };

    // ğŸ”µ INFO: Send POST request
    const response = await fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(configData),
    });

    if (response.ok) {
      showSaveStatus('Settings saved successfully!', true);

      // ğŸŸ  WARNING: Show restart notice if WiFi settings changed
      if (configData.wifi.ssid !== config.wifi.ssid || configData.wifi.password.length > 0) {
        showSaveStatus('WiFi settings changed. Device will restart in 3 seconds...', true);
        setTimeout(() => {
          location.reload();
        }, 3000);
      } else {
        await loadConfig();
      }
    } else {
      // add more info here
      const errorData = await response.json();
      // stringify errorData.message if exists
      const errorMessage = errorData.message ? JSON.stringify(errorData.message) : 'Unknown error';
      showSaveStatus('Failed to save settings: ' + errorMessage, false);
    }
  } catch (error) {
    console.error('Save failed:', error);
    showSaveStatus('Error: ' + error.message, false);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'ğŸ’¾ Save Settings';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Connection Status Update
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateConnectionStatus(connected) {
  const indicator = document.getElementById('connectionStatus');
  const text = indicator.querySelector('.status-text');

  if (connected) {
    indicator.classList.add('connected');
    indicator.classList.remove('error');
    text.textContent = 'Connected';
  } else {
    indicator.classList.remove('connected');
    indicator.classList.add('error');
    text.textContent = 'Connection Lost';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Show Save Status
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showSaveStatus(message, success) {
  const saveStatus = document.getElementById('saveStatus');
  saveStatus.textContent = message;
  saveStatus.className = 'save-status show ' + (success ? 'success' : 'error');

  setTimeout(() => {
    saveStatus.classList.remove('show');
  }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”µ INFO: Installation Mode Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function toggleBottomSensorInstall() {
  const checkbox = document.getElementById('bottomSensorInstall');
  const enabled = checkbox.checked;

  try {
    const response = await fetch('/api/install/bottom', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled }),
    });

    if (response.ok) {
      updateInstallWarning();

      // If enabled, disable the other installation mode
      if (enabled) {
        const motionCheckbox = document.getElementById('motionInstall');
        if (motionCheckbox.checked) {
          motionCheckbox.checked = false;
          await toggleMotionInstall();
        }
      }
    } else {
      checkbox.checked = !enabled;
      alert('Failed to toggle bottom sensor installation mode');
    }
  } catch (error) {
    console.error('Error toggling bottom sensor install mode:', error);
    checkbox.checked = !enabled;
    alert('Error: ' + error.message);
  }
}

async function toggleMotionInstall() {
  const checkbox = document.getElementById('motionInstall');
  const enabled = checkbox.checked;

  try {
    const response = await fetch('/api/install/motion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled }),
    });

    if (response.ok) {
      updateInstallWarning();

      // If enabled, disable the other installation mode
      if (enabled) {
        const bottomCheckbox = document.getElementById('bottomSensorInstall');
        if (bottomCheckbox.checked) {
          bottomCheckbox.checked = false;
          await toggleBottomSensorInstall();
        }
      }
    } else {
      checkbox.checked = !enabled;
      alert('Failed to toggle motion sensor installation mode');
    }
  } catch (error) {
    console.error('Error toggling motion install mode:', error);
    checkbox.checked = !enabled;
    alert('Error: ' + error.message);
  }
}

function updateInstallWarning() {
  const bottomInstall = document.getElementById('bottomSensorInstall').checked;
  const motionInstall = document.getElementById('motionInstall').checked;
  const warning = document.getElementById('installWarning');

  if (bottomInstall || motionInstall) {
    warning.style.display = 'block';
  } else {
    warning.style.display = 'none';
  }
}
