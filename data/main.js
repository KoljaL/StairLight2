// Generated by Copilot
// ðŸ”µ INFO: Main page JavaScript - Effect configuration and control
// âšª NOTE: Handles real-time updates, configuration saving, and effect testing

let config = {};
let statusInterval = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Initialize Page
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('DOMContentLoaded', function () {
  loadConfig();
  startStatusUpdates();
  setupSliderListeners();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Load Configuration from ESP8266
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadConfig() {
  try {
    const response = await fetch('/api/config');
    config = await response.json();

    // ðŸ”µ INFO: Update UI with loaded config
    updateUIFromConfig();
    updateConnectionStatus(true);
  } catch (error) {
    console.error('Failed to load config:', error);
    updateConnectionStatus(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Update UI Elements from Configuration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateUIFromConfig() {
  // ðŸ”µ INFO: Walk-Up Effect
  document.getElementById('walkUpEnabled').checked = config.effects.walkUp.enabled;
  setSliderValue('walkUpBrightness', config.effects.walkUp.brightness);
  setSliderValue('walkUpSpeed', config.effects.walkUp.stepDelay);
  setSliderValue('walkUpFade', config.effects.walkUp.fadeDuration);
  setSliderValue('walkUpOverlap', config.effects.walkUp.overlap);

  // ðŸ”µ INFO: Walk-Down Effect
  document.getElementById('walkDownEnabled').checked = config.effects.walkDown.enabled;
  setSliderValue('walkDownBrightness', config.effects.walkDown.brightness);
  setSliderValue('walkDownSpeed', config.effects.walkDown.stepDelay);
  setSliderValue('walkDownFade', config.effects.walkDown.fadeDuration);
  setSliderValue('walkDownOverlap', config.effects.walkDown.overlap);

  // ðŸ”µ INFO: Walk-Up-Out Effect
  document.getElementById('walkUpOutEnabled').checked = config.effects.walkUpOut.enabled;
  setSliderValue('walkUpOutSpeed', config.effects.walkUpOut.stepDelay);
  setSliderValue('walkUpOutFade', config.effects.walkUpOut.fadeDuration);
  setSliderValue('walkUpOutOverlap', config.effects.walkUpOut.overlap);

  // ðŸ”µ INFO: Walk-Down-Out Effect
  document.getElementById('walkDownOutEnabled').checked = config.effects.walkDownOut.enabled;
  setSliderValue('walkDownOutSpeed', config.effects.walkDownOut.stepDelay);
  setSliderValue('walkDownOutFade', config.effects.walkDownOut.fadeDuration);
  setSliderValue('walkDownOutOverlap', config.effects.walkDownOut.overlap);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Helper Function - Set Slider Value and Update Display
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setSliderValue(id, value) {
  const slider = document.getElementById(id);
  const display = document.getElementById(id + 'Val');
  if (slider && display) {
    slider.value = value;
    display.textContent = value;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Setup Real-Time Slider Update Listeners
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setupSliderListeners() {
  // ðŸ”µ INFO: Get all range inputs and add event listeners
  const sliders = document.querySelectorAll('input[type="range"]');
  sliders.forEach((slider) => {
    slider.addEventListener('input', function () {
      const display = document.getElementById(this.id + 'Val');
      if (display) {
        display.textContent = this.value;
      }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Start Real-Time Status Updates
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function startStatusUpdates() {
  updateStatus();
  statusInterval = setInterval(updateStatus, 2000); // Update every 2 seconds
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Update System Status Display
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function updateStatus() {
  try {
    const response = await fetch('/api/status');
    const status = await response.json();

    // ðŸ”µ INFO: Update effect status
    document.getElementById('effectActive').textContent = status.effectRunning ? 'Yes' : 'No';

    // ðŸ”µ INFO: Update state display
    const stateNames = ['Idle', 'Knight Rider', 'Walk Up', 'Walk Down', 'Hold', 'Walk Up Off', 'Walk Down Off'];
    document.getElementById('currentState').textContent = stateNames[status.currentState] || 'Unknown';

    // ðŸ”µ INFO: Show sensor debug info if debug mode enabled
    if (config.debugMode && status.sensors) {
      const debugPanel = document.getElementById('sensorDebug');
      debugPanel.style.display = 'block';

      document.getElementById('accelMag').textContent = status.sensors.accelMagnitude.toFixed(2) + ' m/sÂ²';
      document.getElementById('bottomSensor').textContent = status.sensors.bottomSensor ? 'ACTIVE' : 'Inactive';
      document.getElementById('motionDetected').textContent = status.sensors.motionDetected ? 'YES' : 'No';
    } else {
      document.getElementById('sensorDebug').style.display = 'none';
    }

    updateConnectionStatus(true);
  } catch (error) {
    console.error('Status update failed:', error);
    updateConnectionStatus(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Update Connection Status Indicator
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateConnectionStatus(connected) {
  const indicator = document.getElementById('connectionStatus');
  const text = indicator.querySelector('.status-text');

  if (connected) {
    indicator.classList.add('connected');
    indicator.classList.remove('error');
    text.textContent = 'Connected';
  } else {
    indicator.classList.remove('connected');
    indicator.classList.add('error');
    text.textContent = 'Connection Lost';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Save Configuration to ESP8266
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function saveConfig() {
  const saveBtn = document.getElementById('saveBtn');
  const saveStatus = document.getElementById('saveStatus');

  // ðŸ”µ INFO: Disable button during save
  saveBtn.disabled = true;
  saveBtn.textContent = 'ðŸ’¾ Saving...';

  try {
    // ðŸ”µ INFO: Collect all form values
    const configData = {
      effects: {
        walkUp: {
          enabled: document.getElementById('walkUpEnabled').checked,
          brightness: parseInt(document.getElementById('walkUpBrightness').value),
          stepDelay: parseInt(document.getElementById('walkUpSpeed').value),
          fadeDuration: parseInt(document.getElementById('walkUpFade').value),
          overlap: parseInt(document.getElementById('walkUpOverlap').value),
        },
        walkDown: {
          enabled: document.getElementById('walkDownEnabled').checked,
          brightness: parseInt(document.getElementById('walkDownBrightness').value),
          stepDelay: parseInt(document.getElementById('walkDownSpeed').value),
          fadeDuration: parseInt(document.getElementById('walkDownFade').value),
          overlap: parseInt(document.getElementById('walkDownOverlap').value),
        },
        walkUpOut: {
          enabled: document.getElementById('walkUpOutEnabled').checked,
          stepDelay: parseInt(document.getElementById('walkUpOutSpeed').value),
          fadeDuration: parseInt(document.getElementById('walkUpOutFade').value),
          overlap: parseInt(document.getElementById('walkUpOutOverlap').value),
        },
        walkDownOut: {
          enabled: document.getElementById('walkDownOutEnabled').checked,
          stepDelay: parseInt(document.getElementById('walkDownOutSpeed').value),
          fadeDuration: parseInt(document.getElementById('walkDownOutFade').value),
          overlap: parseInt(document.getElementById('walkDownOutOverlap').value),
        },
      },
    };

    // ðŸ”µ INFO: Send POST request to save config
    const response = await fetch('/api/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(configData),
    });

    if (response.ok) {
      showSaveStatus('Configuration saved successfully!', true);
      // ðŸ”µ INFO: Reload config to sync with device
      await loadConfig();
    } else {
      showSaveStatus('Failed to save configuration', false);
    }
  } catch (error) {
    console.error('Save failed:', error);
    showSaveStatus('Error: ' + error.message, false);
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'ðŸ’¾ Save Configuration';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Test Effect Function
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function testEffect(effectType) {
  try {
    const response = await fetch('/api/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ effectType: effectType }),
    });

    if (response.ok) {
      console.log('Effect test triggered:', effectType);
    } else {
      console.error('Effect test failed');
    }
  } catch (error) {
    console.error('Test effect error:', error);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ðŸ”µ INFO: Show Save Status Message
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showSaveStatus(message, success) {
  const saveStatus = document.getElementById('saveStatus');
  saveStatus.textContent = message;
  saveStatus.className = 'save-status show ' + (success ? 'success' : 'error');

  // ðŸ”µ INFO: Auto-hide after 3 seconds
  setTimeout(() => {
    saveStatus.classList.remove('show');
  }, 3000);
}
